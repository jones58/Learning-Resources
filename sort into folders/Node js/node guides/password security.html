<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Password security</title><link rel="preload" href="/assets/fonts/GT-Eesti-Text-Light-subset.woff2" as="font" type="font/woff2" crossorigin /><link rel="icon" href="/assets/favicon.svg" /><link href="/assets/css/styles.css" rel="stylesheet" /></head><body><div><header class="hstack jc-between pad-lg"><a href="/" aria-label="Home"><img src="/assets/images/logo.svg" width="100" alt /></a><nav id="global-nav"><ul role="list" class="hstack"><li><a class="global-nav__link" href="/course/introduction/">Course</a></li><li><a class="global-nav__link" href="/resources/introduction/">Resources</a></li><li><a class="global-nav__link" href="/about/">About</a></li></ul></nav></header><div class="center"><div class="layout"><aside></aside><main id="main"><div><header class="vstack gap-xl pad-xl stripes"><div class="vstack" data-gap="md"><h1 class="highlight bg-primary">Password security</h1><p class="highlight fz-lg">Learn the basics of securely storing user passwords on your Node server.</p><ul role="list" class="hstack gap-sm wrap"><li class="highlight fz-sm fw-bold" style="--bg: var(--bg-400)">js</li><li class="highlight fz-sm fw-bold" style="--bg: var(--bg-400)">security</li><li class="highlight fz-sm fw-bold" style="--bg: var(--bg-400)">bcrypt</li></ul></div><div class="hstack wrap"><div class="vstack gap-none"><label for="download-command" class="highlight fw-bold" style="--bg: var(--bg-400)">Download files via CLI</label><copy-text class="hstack gap-none ai-stretch"><input id="download-command" readonly value="npx degit 'foundersandcoders/coursebook/src/workshops/password-security/starter-files#main' password-security" /><button aria-label="Copy" title="Copy" hidden><svg data-copy width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg><svg hidden data-success width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button></copy-text></div><a href="https://github.com/foundersandcoders/coursebook/issues/new?title=%5Bworkshops%2Fpassword-security%5D&amp;labels=feedback" target="_blank" rel="noopener" class="button">Leave feedback<svg viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293a.783.783 0 01.642-.413 41.102 41.102 0 003.55-.414c1.437-.231 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zM6.75 6a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 2.5a.75.75 0 000 1.5h3.5a.75.75 0 000-1.5h-3.5z" clip-rule="evenodd"></path></svg></a></div></header><div style="margin: 4rem 0" class="flow"><p>We’ll look at why you shouldn’t store passwords as plaintext, what hashing and salting are, and how to use the BCrypt algorithm in Node.</p>
<h2 id="setup">Setup <a class="heading-anchor" href="#setup">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<ol>
<li>Download starter files and <code>cd</code> in</li>
<li>Run <code>npm install</code> to install dependencies</li>
<li>Run <code>npm run dev</code> to start the development server</li>
<li>Open <a href="http://localhost:3000">http://localhost:3000</a> in your browser</li>
</ol>
<h3 id="project-structure">Project structure <a class="heading-anchor" href="#project-structure">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h3>
<p>The server has five routes:</p>
<ul>
<li><code>GET /</code>: homepage with links to <code>/sign-up</code> and <code>/log-in</code></li>
<li><code>GET /sign-up</code>: form to create a new user</li>
<li><code>POST /sign-up</code>: new user form submits data to here</li>
<li><code>GET /log-in</code>: form to sign in to an existing account</li>
<li><code>POST /log-in</code> sign in form submits data to here</li>
</ul>
<p>Instead of a real database there’s a hacky custom thing in <code>database/db.js</code> that stores data in a JSON file (don’t worry about trying to read this unless you’re curious). This is both to avoid the complication of setting up a real DB, and so you can see the data getting updated as you use the site. You’ll see a <code>database/db.json</code> file created when you start the server for the first time.</p>
<p>The <code>POST /sign-up</code> handler stores the new user details in the DB. The <code>POST /log-in</code> handler searches the DB for a user with a matching email, then compares the submitted password with the stored user’s password. If they match the user is “logged in”.</p>
<div class="box box-default content flow">
<p>Don’t spend too long on each challenge: you won’t be implementing password hashing yourself in a real app as it’s complicated and dangerous. The steps are there as a learning exercise—the final challenge using the <code>bcryptjs</code> library is how you’d store passwords in a real project.</p>
</div>
<h2 id="plaintext-passwords">Plaintext passwords <a class="heading-anchor" href="#plaintext-passwords">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>Once you’ve started the dev server open <a href="http://localhost:3000">http://localhost:3000</a> in your browser. You should see a sign up form—use this to create an account, then check the <code>workshop/database/db.json</code> file. This is simulating a real database so we can see how our user data is stored.</p>
<p>You should see the user you just created in there. Unfortunately you can see your password stored in plaintext. This means anyone with access to this database can read it.</p>
<p>There are a few problems with this:</p>
<ol>
<li>You (or a future employee of your company) know all users’ password</li>
<li>Passwords are generally re-used for other websites</li>
<li>If a hacker steals your database they immediately know all users’ passwords</li>
</ol>
<p>We have a problem: storing the password as plaintext is bad, but we need to be able to compare a submitted password to a saved one in order to verify users and log them in. This is where hashing is useful.</p>
<h2 id="hashing-passwords">Hashing passwords <a class="heading-anchor" href="#hashing-passwords">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>Hashing is when you use a mathematical process (algorithm) to convert a string into a different one. Hashes are:</p>
<ul>
<li>One-way: it should be impossible to reverse the process.</li>
<li>Deterministic: hashing the same string always gives the same result.</li>
<li>Unique: hashing a different string should never create the same result.</li>
</ul>
<p>For example hashing “hunter2” with the popular “sha256” algorithm always gives us “f52fbd32b2b3b86ff88ef6c490628285f482af15ddcb29541f94bcf526a3f6c7”. There is no way to turn that hash <em>back</em> into “hunter2” again, so it’s safe to store. No other password will create an identical hash.</p>
<p>When a new user signs up we hash their password and store the hash in the database. When they next log in we ask for their password again, hash it again, then compare that hash to the one we have stored. The hashes will only match if the input password was the same both times.</p>
<p>Here’s how we’d create the initial hash using the built-in Node <code>crypto</code> module:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"crypto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token string">"hunter2"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> crypto<br>  <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// "f52fbd32b2b3b86ff88ef6c490628285f482af15ddcb29541f94bcf526a3f6c7"</span></code></pre>
<p>We have to specify which algorithm we want to use (<code>&quot;sha256&quot;</code>) and what encoding the result (or “digest”) string has (hexadecimal).</p>
<p>Here’s roughly how we would verify a user when they signed in again later:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> savedUser <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this would normally be async</span><br><span class="token keyword">const</span> savedHashedPassword <span class="token operator">=</span> savedUser<span class="token punctuation">.</span>password<span class="token punctuation">;</span><br><span class="token keyword">if</span> <span class="token punctuation">(</span>hashedPassword <span class="token operator">!==</span> savedHashedPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"Unauthenticated"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  <span class="token comment">// they are logged in</span><br><span class="token punctuation">}</span></code></pre>
<h3 id="hashing-challenge">Hashing challenge <a class="heading-anchor" href="#hashing-challenge">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h3>
<p>First we need to stop saving users’ passwords in plaintext.</p>
<ul>
<li>Edit the <code>post</code> function in <code>workshop/handlers/signUp.js</code></li>
<li>We want to hash the submitted password using the built-in <code>crypto.createHash()</code> method</li>
<li>Store the hash instead of the plaintext password in the database</li>
<li>Create a new user at <code>/sign-up</code>: you should see a random string password appear in <code>db.json</code><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>  <span class="token property">"users"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>    <span class="token punctuation">{</span><br>      <span class="token property">"email"</span><span class="token operator">:</span> <span class="token string">"test@test.co"</span><span class="token punctuation">,</span><br>      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824"</span><span class="token punctuation">,</span><br>      <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1585842736171</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
</li>
</ul>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token comment">// signUp.js</span><br><br><span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> crypto<br>    <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  model<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> hashedPassword <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1>Welcome </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// plus error handling</span><br><span class="token punctuation">}</span></code></pre>
</details></div>
<p>Then we need to make our logging in comparison work.</p>
<ul>
<li>Edit the <code>post</code> function in <code>workshop/handlers/logIn.js</code></li>
<li>We need to hash the submitted password before we compare it to the stored hash</li>
<li>You should be able to log in as the user you just created</li>
</ul>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token comment">// logIn.js</span><br><br><span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  model<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> crypto<br>      <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>password <span class="token operator">!==</span> hashedPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Password mismatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1>Welcome back, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// plus error handling</span><br><span class="token punctuation">}</span></code></pre>
</details></div>
<h2 id="rainbow-tables">Rainbow tables <a class="heading-anchor" href="#rainbow-tables">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>There are still some issues with our hashed passwords. The only way for a hacker with a stolen database to figure out the passwords is with a “brute force” attack. This is where they use software to automatically try a huge list of possible passwords, hashing each one then comparing it to the passwords in the database.</p>
<p>A good hash algorithm is deliberately quite slow. This limits a hacker who has stolen a database—the brute force attack will take a long time since they’ll have to try thousands of passwords. Hackers can speed this process up by using “rainbow tables”. This is a pre-hashed list of common words so the hacker doesn’t have to hash each password to find a match in the database. For example instead of:</p>
<pre><code>hash(password1) ---(slooow)---&gt; &quot;nkjadfjknadf2e&quot; (no match)
hash(password2) ---(slooow)---&gt; &quot;kmnsdnnmkd2eeb&quot; (no match)
...
</code></pre>
<p>They can skip the hashing part and just try the hashes directly:</p>
<pre><code>&quot;nkjadfjknadf2e&quot; (no match)
&quot;kmnsdnnmkd2eeb&quot; (no match)
...
</code></pre>
<h3 id="salting-challenge">Salting challenge <a class="heading-anchor" href="#salting-challenge">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h3>
<p>We can prevent the use of rainbow tables by “salting” our passwords. This means adding a random string to the password before hashing it. That will ensure our password hashes are unique to our app, and so won’t show up in any rainbow tables.</p>
<p>For example “cupcake” hashed using SHA256 is always <code>&quot;b0eaeafbf3...&quot;</code>. That means the hash can be published in rainbow tables. If we instead add a salt to the password to make <code>&quot;kjnafn9nbjka2kjn.cupcake&quot;</code> then the hash will be <code>&quot;6bc8571635...&quot;</code>, which won’t appear in any rainbow table.</p>
<ul>
<li>
<p>Add a long string to the password before you hash it in <code>workshop/handlers/signUp.js</code></p>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token comment">// signUp.js</span><br><br><span class="token keyword">const</span> <span class="token constant">SALT</span> <span class="token operator">=</span> <span class="token string">"u893qhdnk&amp;892jn9"</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> crypto<br>    <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token constant">SALT</span> <span class="token operator">+</span> password<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  model<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> hashedPassword <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
</details></div>
</li>
<li>
<p>Add the same string to the password before you hash it in <code>workshop/handlers/logIn.js</code> so you can correctly compare it to the hash in the database</p>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token comment">// logIn.js</span><br><span class="token keyword">const</span> <span class="token constant">SALT</span> <span class="token operator">=</span> <span class="token string">"u893qhdnk&amp;892jn9"</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  model<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> crypto<br>      <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"sha256"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token constant">SALT</span> <span class="token operator">+</span> password<span class="token punctuation">)</span><br>      <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>password <span class="token operator">!==</span> hashedPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Password mismatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token comment">// ...</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</details></div>
</li>
</ul>
<div class="box box-default content flow">
<p>You have to use the <strong>same salt</strong> each time, otherwise your comparison will fail.</p>
</div>
<h2 id="random-salt">Random salt <a class="heading-anchor" href="#random-salt">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>We still have a security flaw here: we’re using the same salt for every password, which means our hashes won’t be unique. If you create two new users with the same password you should see the same hash in <code>db.json</code>. This is a problem because as soon as a hacker cracks one hash they’ll have access to all the duplicate passwords.</p>
<p>We can solve this problem by generating a <em>random</em> salt for each new user. This will ensure that each hash is totally unique, even if the password is the same as another user’s.</p>
<p>However we need the salt when the user logs back in, in order to generate the correct hash and verify their password. This means we must store the random salt in the DB along with the password.</p>
<p>This is a fiddly process that is easy to mess up. Instead of implementing it ourselves we’ll rely on a battle-tested library to do it for us.</p>
<h2 id="b-crypt">BCrypt <a class="heading-anchor" href="#b-crypt">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>BCrypt is a popular hashing algorithm. It’s designed specifically for passwords, and (in computer terms) is <em>very</em> slow. This isn’t noticeable to users but makes a brute-force attack much more difficult for a hacker.</p>
<h3 id="bcryptjs-challenge"><code>bcryptjs</code> challenge <a class="heading-anchor" href="#bcryptjs-challenge">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h3>
<p>We’ll be using the <a href="https://www.npmjs.com/package/bcryptjs"><code>bcryptjs</code></a> library (avoid the <code>bcrypt</code> one, which has C++ dependencies and doesn’t work on some systems). This library has methods for hashing/salting and comparing just like we did manually above.</p>
<p>Since BCrypt is supposed to be slow the implementation is <em>asynchronous</em>. So the library’s methods return promises. It has a method for generating a hash. This takes the string to hash and a number representing how strong the salt should be (the higher the number the longer it will take to hash):</p>
<pre class="language-js"><code class="language-js">bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string">"hunter2"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// "$2a$10$MFOIdSobXg.x3ZUfrB2VX.C49DYocYGtBQVJ78ZsC2YwgrALIn1oC"</span></code></pre>
<p>It also has a method for comparing a string to a stored hash. This takes the (unhashed) string to compare as the first argument and the hash as the second argument:</p>
<pre class="language-js"><code class="language-js">bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token string">"hunter2"</span><span class="token punctuation">,</span> storedHash<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>match<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Logs: true if they match, false if not</span></code></pre>
<p>BCrypt automatically stores the salt as part of the hash, so you don’t need to implement that yourself.</p>
<ul>
<li>
<p>Run <code>npm install bcryptjs</code> to install the library</p>
</li>
<li>
<p>Use <code>bcrypt.hash()</code> to hash your password before saving to the DB in <code>signUp.js</code></p>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token comment">//signUp.js</span><br><br><span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  bcrypt<br>    <span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token operator">=></span> model<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> hash <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1>Thanks for signing up, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
</details></div>
</li>
<li>
<p>Use <code>bcrypt.compare()</code> to compare the submitted password to the stored hash in <code>logIn.js</code></p>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token comment">//logIn.js</span><br><br><span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  model<br>    <span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dbUser</span><span class="token punctuation">)</span> <span class="token operator">=></span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> dbUser<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Password mismatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1>Welcome back, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
</li>
</ul>
</details></div>
</div></div></main></div></div></div><script type="module" src="/assets/js/checkboxen.js"></script><script src="/assets/js/toggle-button.js"></script><script src="/assets/js/copy-text.js"></script></body></html>