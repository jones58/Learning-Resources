<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTTP servers with Node &amp; Express</title>
    <link
      rel="preload"
      href="/assets/fonts/GT-Eesti-Text-Light-subset.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link rel="icon" href="/assets/favicon.svg" />
    <link href="/assets/css/styles.css" rel="stylesheet" />
  </head>
  <body>
    <div>
      <header class="hstack jc-between pad-lg">
        <a href="/" aria-label="Home"
          ><img src="/assets/images/logo.svg" width="100" alt
        /></a>
        <nav id="global-nav">
          <ul role="list" class="hstack">
            <li>
              <a class="global-nav__link" href="/course/introduction/"
                >Course</a
              >
            </li>
            <li>
              <a class="global-nav__link" href="/resources/introduction/"
                >Resources</a
              >
            </li>
            <li><a class="global-nav__link" href="/about/">About</a></li>
          </ul>
        </nav>
      </header>
      <div class="center">
        <div class="layout">
          <aside></aside>
          <main id="main">
            <div>
              <header class="vstack gap-xl pad-xl stripes">
                <div class="vstack" data-gap="md">
                  <h1 class="highlight bg-primary">
                    HTTP servers with Node &amp; Express
                  </h1>
                  <p class="highlight fz-lg">
                    Learn how to use Node and Express to create and test HTTP
                    servers
                  </p>
                  <ul role="list" class="hstack gap-sm wrap">
                    <li
                      class="highlight fz-sm fw-bold"
                      style="--bg: var(--bg-400)"
                    >
                      js
                    </li>
                    <li
                      class="highlight fz-sm fw-bold"
                      style="--bg: var(--bg-400)"
                    >
                      express
                    </li>
                    <li
                      class="highlight fz-sm fw-bold"
                      style="--bg: var(--bg-400)"
                    >
                      server
                    </li>
                  </ul>
                </div>
                <div class="hstack wrap">
                  <a
                    href="https://github.com/foundersandcoders/server-challenge"
                    target="_blank"
                    rel="noopener"
                    class="button"
                    style="
                      --bg: var(--primary);
                      --bg-hover: var(--primary-dark);
                    "
                    >View challenge repo<svg
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      width="16"
                      height="16"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5z"
                        clip-rule="evenodd"
                      ></path>
                      <path
                        fill-rule="evenodd"
                        d="M6.194 12.753a.75.75 0 001.06.053L16.5 4.44v2.81a.75.75 0 001.5 0v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 000 1.5h2.553l-9.056 8.194a.75.75 0 00-.053 1.06z"
                        clip-rule="evenodd"
                      ></path></svg></a
                  ><a
                    href="https://github.com/foundersandcoders/coursebook/issues/new?title=%5Blearn%2Fserver%5D&amp;labels=feedback"
                    target="_blank"
                    rel="noopener"
                    class="button"
                    >Leave feedback<svg
                      viewBox="0 0 20 20"
                      fill="currentColor"
                      width="16"
                      height="16"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293a.783.783 0 01.642-.413 41.102 41.102 0 003.55-.414c1.437-.231 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zM6.75 6a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 2.5a.75.75 0 000 1.5h3.5a.75.75 0 000-1.5h-3.5z"
                        clip-rule="evenodd"
                      ></path></svg
                  ></a>
                </div>
              </header>
              <div style="margin: 4rem 0" class="flow">
                <p>
                  Node is often used to create HTTP servers for the web. It’s a
                  bit fiddly to do this with just the built-in modules, so we’re
                  going to use the Express library to help create our server.
                </p>
                <h2 id="http-recap">
                  HTTP recap
                  <a class="heading-anchor" href="#http-recap">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  HyperText Transfer Protocol (HTTP) is a way for computers to
                  exchange messages over the internet. The “client” computer
                  will send a “request” (often via a web browser). E.g. if you
                  visit <a href="https://google.com">https://google.com</a> your
                  browser sends a request like this:
                </p>
                <pre><code>GET / HTTP/1.1
host: google.com
accept: text/html
</code></pre>
                <p>
                  A “server” computer receives this request and sends a
                  “response”. E.g. Google’s server would send a response like
                  this:
                </p>
                <pre><code>HTTP/1.1 200 Ok
content-type: text/html

&lt;!doctype html&gt;
&lt;html&gt;&lt;body&gt;&lt;h1&gt;Welcome to Google&lt;/h1&gt;...&lt;/body&gt;&lt;/html&gt;
</code></pre>
                <p>
                  We’re going to learn how to use Node to create an HTTP server
                  that can respond to requests.
                </p>
                <h2 id="getting-started">
                  Getting started
                  <a class="heading-anchor" href="#getting-started">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <ol>
                  <li>
                    Create a new directory
                    <pre
                      class="language-shell"
                    ><code class="language-shell"><span class="token function">mkdir</span> node-server-intro</code></pre>
                  </li>
                  <li>
                    Move into that directory
                    <pre
                      class="language-shell"
                    ><code class="language-shell"><span class="token builtin class-name">cd</span> node-server-intro</code></pre>
                  </li>
                  <li>
                    Create an empty <code>package.json</code>
                    <pre
                      class="language-shell"
                    ><code class="language-shell"><span class="token function">npm</span> init <span class="token parameter variable">-y</span></code></pre>
                  </li>
                  <li>
                    Install the Express library
                    <pre
                      class="language-shell"
                    ><code class="language-shell"><span class="token function">npm</span> <span class="token function">install</span> express</code></pre>
                  </li>
                  <li>
                    Open your editor, then create a <code>server.js</code> file
                    <pre
                      class="language-shell"
                    ><code class="language-shell">code <span class="token builtin class-name">.</span></code></pre>
                  </li>
                </ol>
                <p>Follow along with each example in your own editor.</p>
                <hr />
                <h2 id="common-js-modules">
                  CommonJS modules
                  <a class="heading-anchor" href="#common-js-modules">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  Before we start creating a server we need to learn how Node
                  manages code in different files. Modules are used to isolate
                  code. In the browser by default all JS has access to the same
                  global scope, even if loaded via separate script tags.
                </p>
                <p>
                  Although browsers do now have
                  <a
                    href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules"
                    >Modules</a
                  >
                  Node was created before they were added to JavaScript. This
                  means it has its own system (called “CommonJS”).
                </p>
                <p>
                  Confusingly Node has recently added support for these standard
                  JS modules (ESM), however most server code has not yet been
                  updated, so we must learn the older system.
                </p>
                <h3 id="exporting-code">
                  Exporting code
                  <a class="heading-anchor" href="#exporting-code">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  By default all files are self-contained in Node. Code in one
                  file cannot access anything in another file. To use something
                  in another file you must “export” it. You can do so by
                  assigning the value to <code>module.exports</code>:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// messages.js</span><br><span class="token keyword">const</span> message1 <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> message2 <span class="token operator">=</span> <span class="token string">"goodbye"</span><span class="token punctuation">;</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> message1<span class="token punctuation">;</span></code></pre>
                <h3 id="importing-code">
                  Importing code
                  <a class="heading-anchor" href="#importing-code">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  To access code that is exported from another file you must
                  “import” it. You can do so by calling the
                  <code>require</code> function with the path to the file:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// index.js</span><br><span class="token keyword">const</span> whateverNameWeWant <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./messages.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>whateverNameWeWant<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs: "hello"</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Error: message2 is not defined</span></code></pre>
                <p>
                  Note: the file extension is optional—if you leave it off Node
                  will assume it’s a <code>.js</code> file. This is quite common
                  in the Node ecosystem.
                </p>
                <h3 id="multiple-exports">
                  Multiple exports
                  <a class="heading-anchor" href="#multiple-exports">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  You can export multiple values by assigning an object to
                  <code>module.exports</code>:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// messages.js</span><br><span class="token keyword">const</span> message1 <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> message2 <span class="token operator">=</span> <span class="token string">"goodbye"</span><span class="token punctuation">;</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token literal-property property">message1</span><span class="token operator">:</span> message1<span class="token punctuation">,</span><br>  <span class="token literal-property property">message2</span><span class="token operator">:</span> message2<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// index.js</span><br><span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./messages.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// or using destructuring:</span><br><span class="token comment">// const { message1, message2 } = require("./messages.js");</span><br><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span>message1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs: "hello"</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span>message2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs: "goodbye"</span></code></pre>
                <h3 id="built-in-and-3rd-party-modules">
                  Built-in &amp; 3rd party modules
                  <a
                    class="heading-anchor"
                    href="#built-in-and-3rd-party-modules"
                  >
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  Node provides some built-in modules. You can import these just
                  like your own modules, only without the path (just using their
                  name). Recent versions of Node allow you to add the
                  <code>node:</code> prefix to make it more explicit that this
                  is a built-in. For example to use the built-in “fs”
                  (filesystem) module:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">"my-file.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  The same applies to modules you installed via npm. Node will
                  check in your <code>node_modules</code> directory to find any
                  imports that aren’t relative file paths. For example to import
                  the Express library:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Now we know how to manage our modules let’s take a look at
                  using Express to build a server.
                </p>
                <hr />
                <h2 id="creating-a-server">
                  Creating a server
                  <a class="heading-anchor" href="#creating-a-server">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  We can create a new server object using the
                  <code>express</code> library:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>You can run this file from your terminal with:</p>
                <pre
                  class="language-shell"
                ><code class="language-shell"><span class="token function">node</span> server.js</code></pre>
                <p>
                  Unfortunately nothing much will happen yet, since we haven’t
                  told our server to <em>do</em> anything.
                </p>
                <h2 id="starting-the-server">
                  Starting the server
                  <a class="heading-anchor" href="#starting-the-server">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  Our server isn’t currently listening for requests. Servers
                  need to connect to the network and listen for incoming HTTP
                  requests via a “port”.
                </p>
                <div class="box box-default content flow">
                  <p>
                    A port is an entry/exit point on a computer to allow network
                    connections (like an airport allows people in/out of a
                    country). Your computer has a lot of these, and identifies
                    them using numbers. HTTP requests use
                    <strong>port 80</strong> by default (and HTTPS requests use
                    <strong>443</strong>). You don’t normally see them in URLs
                    on the web because browsers use the default. I.e. when you
                    visit <code>https://google.com</code> you are really going
                    to <code>https://google.com:443</code>.
                  </p>
                  <p>
                    When you’re running a server locally in development it’s
                    common to use a different number like 3000 or 8080. You can
                    access a port by adding it to a URL like this:
                    <code>http://localhost:3000</code>.
                  </p>
                </div>
                <p>
                  It’s a good idea to start the server in a different file: this
                  will help with testing later on. We first need to export the
                  server object we just created:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// server.js</span><br><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> server<span class="token punctuation">;</span></code></pre>
                <p>
                  Then we create a new file named <code>index.js</code> file.
                  This is just the “entrypoint” for our app—its job is to start
                  the server. All the actual server logic will stay in
                  <code>server.js</code>.
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// index.js</span><br><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./server.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  This tells the server to listen for any requests sent to
                  <strong>port 3000</strong>. Now we can run the program in our
                  terminal again:
                </p>
                <pre
                  class="language-shell"
                ><code class="language-shell"><span class="token function">node</span> index.js</code></pre>
                <p>
                  The server will start, but you won’t see anything happen. Your
                  terminal will be “stuck” as the Node process is still running
                  (the server will keep listening indefinitely). This means you
                  can’t run any more commands.
                </p>
                <div class="box box-error content flow">
                  <p>
                    <strong>Important</strong>: You can stop the Node process by
                    typing <kbd>control</kbd> + <kbd>c</kbd> in your terminal.
                    Every time you change your code you must stop the old
                    process and start a new one by running
                    <code>node server.js</code> again.
                  </p>
                </div>
                <p>
                  It would be nice see a log so we know our server started
                  correctly. Luckily the <code>.listen</code> method takes a
                  second argument—a function to run once the server is
                  listening.
                </p>
                <p>We can use this to log a message:</p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Listening at http://localhost:3000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Stop the previous process, re-run your file, and you should
                  see “Listening on
                  <a href="http://localhost:3000">http://localhost:3000</a>”
                  logged.
                </p>
                <h2 id="trying-out-our-server">
                  Trying out our server
                  <a class="heading-anchor" href="#trying-out-our-server">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  Since your server is now running you can send some HTTP
                  requests to it to see what happens. The easiest way is to
                  visit
                  <a href="http://localhost:3000/">http://localhost:3000/</a> in
                  your browser.
                </p>
                <p>
                  You can also use the <code>curl</code> CLI program to send
                  requests right from your terminal. Open a new tab and run this
                  command to send a GET request:
                </p>
                <pre
                  class="language-shell"
                ><code class="language-shell"><span class="token function">curl</span> localhost:3000</code></pre>
                <p>
                  You should see the response logged. Whether your used your
                  browser or <code>curl</code> you should get a
                  <code>404 Not found</code> response from your server.
                </p>
                <p>
                  This is Express’ default “missing” page, which it will return
                  when you haven’t defined a response for a particular request.
                  Let’s fix that by defining our first route.
                </p>
                <h2 id="handling-requests">
                  Handling requests
                  <a class="heading-anchor" href="#handling-requests">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  Our server currently does nothing. We need to add a “route”.
                  This is a function that will be run whenever the server
                  receives a request for a specific path.
                </p>
                <p>
                  The <code>server</code> object has methods representing all
                  the HTTP verbs (<code>GET</code>, <code>POST</code> etc).
                  These methods take two arguments: the path to match and a
                  handler function.
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// server.js</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Here we tell the server to call our function whenever it
                  receives a HTTP GET request to the home path. This is similar
                  to an event listener in the DOM.
                </p>
                <p>
                  The handler function will be passed two arguments: an object
                  representing the incoming request, and an object representing
                  the response that will eventually be sent. Here we’ve named
                  them <code>request</code> and
                  <code>response</code> respectively. These are often
                  abbreviated to <code>req</code> and <code>res</code>.
                </p>
                <p>
                  We can use the <code>send</code> method of the response object
                  to tell Express to send the response. Whatever argument we
                  pass will be sent as the response body.
                </p>
                <p>
                  Open
                  <a href="http://localhost:3000/">http://localhost:3000/</a> in
                  your browser. This will send a <code>GET</code> request to
                  your server. You should see the “hello” response on the page.
                  It’s helpful to open the network tab of the dev tools so you
                  can see all the details of the request and response.
                </p>
                <hr />
                <h2 id="testing-our-server">
                  Testing our server
                  <a class="heading-anchor" href="#testing-our-server">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  Making requests manually in the browser or terminal is fine
                  for quick checks, but to be responsible developers we should
                  write automated tests to verify our server is working
                  correctly.
                </p>
                <h3 id="testing-with-node">
                  Testing with Node
                  <a class="heading-anchor" href="#testing-with-node">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  As of version 18 Node has a built-in test runner. It works in
                  a similar way to the popular Tape testing library (most
                  testing libraries are quite similar).
                </p>
                <p>
                  Let’s try an example test. Create a new directory called
                  <code>test/</code>, and then a new file inside called
                  <code>server.test.js</code>. We can create a simple test like
                  this:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:assert"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"the test works"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Since this is a normal Node JS file we can run it from our
                  terminal like any other JS file:
                </p>
                <pre
                  class="language-shell"
                ><code class="language-shell"><span class="token function">node</span> test/server.test.js</code></pre>
                <p>You should see some logs showing the status of your test.</p>
                <p>
                  Node also has a special way to run all the tests in your
                  project:
                </p>
                <pre
                  class="language-shell"
                ><code class="language-shell"><span class="token function">node</span> <span class="token parameter variable">--test</span></code></pre>
                <p>
                  It will find and run any files in a folder named
                  <code>test</code>, and also any file ending in
                  <code>.test.js</code>. This is handy when you want to divide
                  your tests up into different files but run them all in one go.
                </p>
                <h3 id="testing-our-server-2">
                  Testing our server
                  <a class="heading-anchor" href="#testing-our-server-2">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  Let’s write a test that verifies the route we just added. Our
                  test should:
                </p>
                <ol>
                  <li>Start the server</li>
                  <li>Send a request to the server</li>
                  <li>Verify the request was successful</li>
                  <li>Retrieve the response body</li>
                  <li>Verify that the response is what we expect</li>
                  <li>Stop the server</li>
                </ol>
                <p>
                  Note that this is exactly how we <em>manually</em> checked our
                  server was working before. We just want to automate it.
                </p>
                <div class="box box-default content flow">
                  <p>
                    Remember you can run your test in the terminal at each step
                    with <code>node --test</code>
                  </p>
                </div>
                <p>
                  First we need a test function. We will use an
                  <code>async</code> function here so that Node knows to wait
                  for any promises to resolve:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:assert"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"home route returns expected page"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// test goes here</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <h4 id="start-the-server">
                  Start the server
                  <a class="heading-anchor" href="#start-the-server">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h4>
                <p>
                  Next we need to start the server. We’ll use a different port
                  to before, just so we don’t clash with any already running
                  instances in your terminal:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token keyword">const</span> test <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:assert"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"../server.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"home route returns expected page"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> app <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9876</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  We import the server object directly and start it listening
                  ourselves. This is why splitting up our app into
                  <code>index.js</code> and <code>server.js</code> helps
                  testing: we have control over when the server starts.
                </p>
                <h4 id="send-a-request-to-the-server">
                  Send a request to the server
                  <a
                    class="heading-anchor"
                    href="#send-a-request-to-the-server"
                  >
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h4>
                <p>
                  Now we need to send a request to the server. As of Node 18 we
                  can use <code>fetch</code> to make HTTP requests, just like in
                  the browser. We can use it to send a request to our server:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"home route returns expected page"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> app <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9876</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Here we’re sending a request, waiting for the server to
                  respond, closing the server, then checking that the response
                  was successful. We need to close the server
                  <em>before</em> any assertions, since the test will stop
                  executing as soon as an assertion fails. If that happened
                  before we closed it the server would never stop listening.
                </p>
                <div class="box box-default content flow">
                  <p>
                    We’re using
                    <a href="https://javascript.info/async-await"
                      ><code>await</code></a
                    >
                    to simplify the promise-handling here. We could use the
                    <code>.then()</code> callback method but the test would end
                    up a bit more convoluted.
                  </p>
                </div>
                <h4 id="check-the-response-body">
                  Check the response body
                  <a class="heading-anchor" href="#check-the-response-body">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h4>
                <p>
                  Finally we need to get the response body and check that it is
                  correct:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"home route returns expected page"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> app <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9876</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Here we’re using the <code>.text()</code> method to get the
                  raw text content of the response body, then checking it
                  matches what we expect.
                </p>
                <p>
                  Now that we know how to test our server we can get back to
                  learning a bit more about Express.
                </p>
                <hr />
                <h2 id="port-flexibility">
                  Port flexibility
                  <a class="heading-anchor" href="#port-flexibility">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  We are currently hard-coding the port our server listens on to
                  <code>3000</code>. This works fine, but we could make it more
                  flexible. When you deploy this code to a hosting provider like
                  Heroku they will run your code on their computer. This
                  computer may have lots of different programs running that all
                  need to use ports. Ideally the host can tell your server which
                  port to listen to.
                </p>
                <p>
                  This is usually achieved with
                  <a href="https://en.wikipedia.org/wiki/Environment_variable"
                    >environment variables</a
                  >. These are like global variables that are set
                  <em>before</em> your program runs. For example we can set a
                  variable named <code>TEST</code> in our terminal like this:
                </p>
                <pre
                  class="language-shell"
                ><code class="language-shell"><span class="token assign-left variable">TEST</span><span class="token operator">=</span><span class="token number">123</span> <span class="token function">node</span> index.js</code></pre>
                <p>
                  <strong>Remember</strong> if you are using
                  <strong>Windows (without WSL)</strong> you will have to use
                  the SET command and ampersands between commands like this:
                </p>
                <pre
                  class="language-shell"
                ><code class="language-shell">SET <span class="token assign-left variable">TEST</span><span class="token operator">=</span><span class="token number">123</span> <span class="token operator">&amp;</span> <span class="token function">node</span> index.js</code></pre>
                <p>
                  Node makes environment variables available via the global
                  <code>process.env</code> object. So we could read that
                  <code>TEST</code> variable using this JS:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Logs: 123</span></code></pre>
                <p>
                  We can tweak our server code in <code>index.js</code> to use a
                  <code>PORT</code> environment variable if it’s set, otherwise
                  fallback to <code>3000</code>:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// index.js</span><br><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./server.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">;</span><br>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Listening at http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Now we can control what port our server listens on without
                  editing the code. E.g. to start it using a different port:
                </p>
                <pre
                  class="language-shell"
                ><code class="language-shell"><span class="token assign-left variable">PORT</span><span class="token operator">=</span><span class="token number">8080</span> <span class="token function">node</span> index.js</code></pre>
                <p>
                  When you deploy to a hosting provider like Heroku they will
                  use this to start your server with a random available port.
                </p>
                <hr />
                <h2 id="the-response">
                  The response
                  <a class="heading-anchor" href="#the-response">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>HTTP responses need a few different things:</p>
                <ol>
                  <li>
                    A status code (e.g. <code>200</code> for success or
                    <code>404</code> for not found)
                  </li>
                  <li>Headers to provide info about the response</li>
                  <li>A body (the response data itself)</li>
                </ol>
                <h3 id="status-code">
                  Status code
                  <a class="heading-anchor" href="#status-code">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  Our home route currently only provides the body, as Express
                  will set the status code to <code>200</code> by default when
                  you call <code>response.send()</code>. To set a different code
                  use the <code>response.status</code> method. Let’s add a new
                  route that returns a different status code:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/uh-oh"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"something went wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  You can chain <code>.status</code> together with
                  <code>.send</code> to make it shorter:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"something went wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Try creating a test for this new route in
                  <code>tests/server.test.js</code>: it should check that the
                  status is <code>500</code> and the body is “something went
                  wrong”. It will look very similar to the first test we wrote.
                </p>
                <div class="box box-success content">
                  <details class="disclosure flow">
                    <summary>Toggle answer</summary>
                    <pre
                      class="language-js"
                    ><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"/uh-oh route returns error message"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> app <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9876</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9876/uh-oh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"something went wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                  </details>
                </div>
                <h3 id="headers">
                  Headers
                  <a class="heading-anchor" href="#headers">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  Express will automatically set some HTTP headers describing
                  the response. For example since we called
                  <code>send</code> with a string it will set the
                  <code>content-type</code> to <code>text/html</code> and the
                  <code>content-length</code> to the size of the string.
                </p>
                <p>
                  You can set your own headers using the
                  <code>response.set</code> method. This can take two strings to
                  set a single header:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">response<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"x-fake-header"</span><span class="token punctuation">,</span> <span class="token string">"my-value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Or it can take an object of string values to set multiple
                  headers:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">response<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  <span class="token string-property property">"x-fake-header"</span><span class="token operator">:</span> <span class="token string">"my value"</span><span class="token punctuation">,</span><br>  <span class="token string-property property">"x-another-header"</span><span class="token operator">:</span> <span class="token string">"another value"</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <h3 id="html-body">
                  HTML body
                  <a class="heading-anchor" href="#html-body">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  We aren’t limited to plaintext in our body. The browser will
                  parse any HTML tags and render them on the page. Change your
                  home route to return some HTML instead:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br>    &lt;!doctype html><br>    &lt;html><br>      &lt;head><br>        &lt;meta charset="utf-8"><br>        &lt;title>Home&lt;/title><br>      &lt;/head><br>      &lt;body><br>        &lt;h1>Hello&lt;/h1><br>      &lt;/body><br>    &lt;/html><br>  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Run your tests again and you should see the first one fail,
                  since it is still expecting the response body to be “hello”.
                  Amend the test so that it matches the new body.
                </p>
                <div class="box box-default content flow">
                  <p>
                    <strong>Hint:</strong> You can use
                    <a
                      href="https://nodejs.org/api/assert.html#assertmatchstring-regexp-message"
                      ><code>assert.match</code></a
                    >
                    to match a string to a regular expression. This allows you
                    to check if it includes a certain substring without having
                    to compare the whole thing.
                  </p>
                </div>
                <div class="box box-success content">
                  <details class="disclosure flow">
                    <summary>Toggle answer</summary>
                    <pre
                      class="language-js"
                    ><code class="language-js"><span class="token comment">// ...</span><br>assert<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">Hello</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                  </details>
                </div>
                <p>
                  Visit
                  <a href="http://localhost:3000/">http://localhost:3000/</a>
                  again and you should see an <code>h1</code> rendered.
                </p>
                <p>
                  Since we’re rendering HTML using JS strings we can insert
                  dynamic values using template literals. Let’s add the current
                  year to the response:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> year <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFullYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br>    &lt;!doctype html><br>    &lt;html><br>      &lt;head><br>        &lt;meta charset="utf-8"><br>        &lt;title>Home&lt;/title><br>      &lt;/head><br>      &lt;body><br>        &lt;h1>Hello, it's </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>year<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h1><br>      &lt;/body><br>    &lt;/html><br>  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>You’ll need to amend your test again to keep it passing.</p>
                <!-- ### JSON body

If you were creating an API you might not want to send HTML. Express supports easily sending structured data back as JSON. Add a new route to your server:

```js
server.get("/json", (request, response) => {
  response.send({ message: "Hello" });
});
```

HTTP response bodies are always strings, so Express will automatically convert our object to a JSON string for us. It will also set the `content-type` header to `application/json`.

Visit http://localhost:3000/json and you should see a JSON object with a `message` property.

### Redirects

Sometimes we want to _redirect_ the request to another URL. You can use the `response.redirect` method for this. Add a new route:

```js
server.get("/redirects", (request, response) => {
  response.redirect("/");
});
```

Now if you visit http://localhost:3000/redirects in your browser you should end up back on the home page. If you look at the network tab in the dev tools you'll see two requests.

First a request to `/redirects`. This has a response status code of `302` and a `location` header pointing to `/`. This tells the browser to then make a second request to `/`. -->
                <h2 id="the-request">
                  The request
                  <a class="heading-anchor" href="#the-request">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  Now let’s look at the HTTP request. This object include lots
                  of information that’s useful to us.
                </p>
                <h3 id="search-parameters">
                  Search parameters
                  <a class="heading-anchor" href="#search-parameters">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  Incoming request URLs can contain extra information known as
                  “search parameters” (or sometimes “query parameters”). These
                  are key/value pairs listed after a <code>?</code> character in
                  the URL.
                </p>
                <p>
                  They are usually added to the URL automatically as the result
                  of a form submission. For example this form:
                </p>
                <pre
                  class="language-html"
                ><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/search<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>GET<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><br>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>keyword<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span></code></pre>
                <p>
                  will send a GET request to
                  <code>/search?keyword=what-the-user-typed</code>. This allows
                  your server to receive user-submitted information.
                </p>
                <p>
                  Let’s write a test <em>first</em> before we try to implement
                  this. Our route is going to be simple: it will return a
                  message telling the user what keyword they submitted. Our new
                  test should check that a request to
                  <code>/search?keyword=bananas</code> returns a body including
                  “You searched for bananas”.
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// tests/server.test.js</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"/search returns message including keyword"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> app <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9876</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9876/search?keyword=bananas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  assert<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">You searched for bananas</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  This test will currently fail when you run it, as we now need
                  to implement the new route in <code>server.js</code>.
                </p>
                <p>
                  Express provides the search parameters from the URL on the
                  <code>request.query</code> object. Each
                  <code>key=value</code> pair will be parsed and represented as
                  an object property.
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// server.js</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/search"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> keyword <span class="token operator">=</span> request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>keyword<span class="token punctuation">;</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p>You searched for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>keyword<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
                <p>
                  Your test should now pass when you run it. If you visit
                  <a href="http://localhost:3000/search?keyword=css"
                    >http://localhost:3000/search?keyword=css</a
                  >
                  you should see “You searched for css” on the page.
                </p>
                <h3 id="dynamic-paths">
                  Dynamic paths
                  <a class="heading-anchor" href="#dynamic-paths">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  Sometimes you can’t know in advance all the routes you need.
                  For example if you wanted a page for each user profile in your
                  app: <code>/users/oli</code>, <code>/users/dan</code> etc. You
                  can’t statically list <em>every</em> possible route here.
                  Instead you can use a placeholder value in the path to
                  indicate that part of it is variable:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/users/:name"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> name <span class="token operator">=</span> request<span class="token punctuation">.</span>params<span class="token punctuation">.</span>name<span class="token punctuation">;</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1>Hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  We use a colon (<code>:</code>) to indicate to Express that
                  <em>any</em> value can match a part of the path. It will put
                  any matched values on the <code>request.params</code> object
                  so you can use them. For example a request to
                  <code>/users/oli</code> would result in a
                  <code>request.params</code> object like:
                  <code>{ name: &quot;oli&quot; }</code>.
                </p>
                <p>
                  If you visit
                  <a href="http://localhost:3000/users/oli"
                    >http://localhost:3000/users/oli</a
                  >
                  you should see “Hello oli”. If you visit
                  <a href="http://localhost:3000/users/knadkmnaf"
                    >http://localhost:3000/users/knadkmnaf</a
                  >
                  you should see “Hello knadkmnaf”.
                </p>
                <hr />
                <h2 id="missing-routes">
                  Missing routes
                  <a class="heading-anchor" href="#missing-routes">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  Try visiting
                  <a href="http://localhost:3000/asdfg"
                    >http://localhost:3000/asdfg</a
                  >
                  in your browser. You should see
                  <code>Cannot GET /asdfg</code>. This is Express’ default
                  response for when no handler matches a path.
                </p>
                <p>
                  You can customise this by putting a “catch-all” handler after
                  all your other routes. If no other route matches then this
                  will be used (since Express matches them in the order they are
                  defined).
                </p>
                <p>
                  We can use the <code>server.use</code> method to create a
                  handler that will match <em>any</em> method/route:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"&lt;h1>Not found&lt;/h1>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Reload
                  <a href="http://localhost:3000/asdfg"
                    >http://localhost:3000/asdfg</a
                  >
                  and you should now see your custom response. Try writing a
                  test that checks whether requests to different URLs correctly
                  return this 404 response.
                </p>
                <div class="box box-success content">
                  <details class="disclosure flow">
                    <summary>Toggle answer</summary>
                    <pre
                      class="language-js"
                    ><code class="language-js"><span class="token comment">// tests/server.test.js</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"missing routes return 404 response"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> app <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9876</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9876/definitely-not-real"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  assert<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">Not found</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                  </details>
                </div>
                <h2 id="middleware">
                  Middleware
                  <a class="heading-anchor" href="#middleware">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  Express route handlers don’t have to send a response. They
                  actually receive a third argument: the
                  <code>next</code> function. Calling this function tells
                  Express to move on to the next handler registered for the
                  route, without sending a response to the browser.
                </p>
                <p>
                  Let’s add another handler for the home route. It will just log
                  the request, then move on to the next handler:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>method <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  If you run this code and refresh the home page you should see
                  <code>GET /</code> logged in your terminal.
                </p>
                <p>
                  The route methods like <code>.get</code> accept multiple
                  handler functions, so you can actually pass several all in one
                  go. I.e. this does the same thing as above:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>method <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> logger<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"&lt;h1>Hello&lt;/h1>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Express calls handlers that don’t send a response
                  “middleware”. Our example here isn’t that useful, but we could
                  change it to run before <em>all</em> requests. We can do this
                  with <code>server.use</code>:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Now we’ll get a helpful log like <code>GET /</code> in our
                  terminal when we load any page. Without middleware we would
                  have to copy this into every route we wrote.
                </p>
                <p>
                  We’ll be making more use of middleware in later topics where
                  we have shared logic that must run on many different routes.
                </p>
                <h2 id="static-files">
                  Static files
                  <a class="heading-anchor" href="#static-files">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  It’s common to have some static files that don’t change for
                  each request. E.g. CSS, images, maybe some basic HTML pages.
                  For convenience Express includes a built-in middleware for
                  serving a directory of files: <code>express.static</code>.
                </p>
                <p>
                  Create a new directory named <code>public</code>. This is
                  where we’ll keep all the files sent to the client. Create a
                  <code>public/style.css</code> file with some example CSS:
                </p>
                <pre
                  class="language-css"
                ><code class="language-css"><span class="token comment">/* public/style.css */</span><br><br><span class="token selector">body</span> <span class="token punctuation">{</span><br>  <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
                <p>Finally configure the middleware to serve this directory:</p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// server.js</span><br><br><span class="token keyword">const</span> staticHandler <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">"public"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>staticHandler<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  The server will now handle requests to
                  <a href="http://localhost:3000/style.css"
                    >http://localhost:3000/style.css</a
                  >
                  and respond with the file contents. Note that there is no
                  <code>public</code> in the final URL: Express serves the files
                  from the root of the site.
                </p>
                <p>
                  We can link this CSS from our homepage to apply the styles:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br>    &lt;!doctype html><br>    &lt;html><br>      &lt;head><br>        &lt;meta charset="utf-8"><br>        &lt;title>Home&lt;/title><br>        &lt;link rel="stylesheet" href="/style.css"><br>      &lt;/head><br>      &lt;body><br>        &lt;h1>Hello&lt;/h1><br>      &lt;/body><br>    &lt;/html><br>  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Visit
                  <a href="http://localhost:3000/">http://localhost:3000/</a> in
                  your browser again and you should see the styles applied.
                </p>
                <h2 id="post-requests">
                  Post requests
                  <a class="heading-anchor" href="#post-requests">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h2>
                <p>
                  So far we’ve only created <code>GET</code> handlers. Let’s add
                  a <code>POST</code> handler to see how we’d deal with forms
                  submitting user data to our server:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js">server<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/submit"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"thanks for submitting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  We can’t make a <code>POST</code> request as easily in our
                  browser, since that would require a form. Instead let’s write
                  a test to check this worked.
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// tests/server.test.js</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"/submit route responds to POST requests"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> app <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9876</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9876/submit"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  assert<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">thanks for submitting</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <h3 id="request-body">
                  Request body
                  <a class="heading-anchor" href="#request-body">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  A <code>POST</code> request that doesn’t send any data isn’t
                  very useful. Usually a form would be submitting some user
                  input. Let’s imagine we have a form that asks a user’s name.
                  We want to get the name they submit and send back a message
                  like “thanks for submitting, oli”.
                </p>
                <p>
                  Since bodies can be large they are sent in small chunks—this
                  means there’s no simple way to read the body. Instead we must
                  use a “body parser” middleware. This will wait for all the
                  chunks to be received, then make the final body available to
                  our route handler via the request object.
                </p>
                <p>
                  For convenience Express includes parsers for different
                  formats. Request bodies can come in different formats (JSON,
                  form submission etc), so we must use the right middleware. We
                  want <code>express.urlencoded</code>, which is what HTML forms
                  submit by default. It will add a
                  <code>request.body</code> property, which is an object
                  containing the submitted data:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// server.js</span><br><br><span class="token keyword">const</span> bodyParser <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/submit"</span><span class="token punctuation">,</span> bodyParser<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> name <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">;</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">thanks for submitting, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  Now we can update our test to send a URL-encoded body as part
                  of the POST request. We need to make sure we add the right
                  content-type header to the request, as this is how Express
                  knows how to decode the body. We’ll also change the assertion
                  to expect the right response:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// tests/server.test.js</span><br><br><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">"/submit route responds to POST requests"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> app <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9876</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:9876/submit"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">"name=oli"</span><span class="token punctuation">,</span><br>    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>      <span class="token string-property property">"content-type"</span><span class="token operator">:</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  app<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  assert<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">thanks for submitting, oli</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
                <p>
                  This test simulates how a real form in the browser would send
                  a POST request.
                </p>
                <h3 id="redirecting-responses">
                  Redirecting responses
                  <a class="heading-anchor" href="#redirecting-responses">
                    <svg
                      viewBox="0 0 32 32"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="currentcolor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                    >
                      <path
                        d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
                      ></path>
                    </svg>
                  </a>
                </h3>
                <p>
                  It’s not good practice to send a response directly from a POST
                  request like this. It can cause issues with duplicate
                  requests—the POST will be re-submitted if the user refreshes
                  the resulting page. This is why some retailers ask you to not
                  refresh the page after buying something, to avoid being
                  charged twice.
                </p>
                <p>
                  A safer pattern is to always <em>redirect</em> to the next
                  page after a POST request. That will tell the browser to send
                  a new GET request to the next page, avoiding any resubmission
                  problems.
                </p>
                <p>
                  We can use the <code>response.redirect</code> method to return
                  a redirect response:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// server.js</span><br><br><span class="token keyword">const</span> bodyParser <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">"/submit"</span><span class="token punctuation">,</span> bodyParser<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> name <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">;</span><br>  response<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/submit/success?name=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  The next page needs to know the name that was submitted—we can
                  pass that in the URL using the search parameters (in a “real”
                  app this might be stored in a cookie or database, but the URL
                  is fine for now). We then need a new route to show the
                  “success” page:
                </p>
                <pre
                  class="language-js"
                ><code class="language-js"><span class="token comment">// server.js</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/submit/success"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> name <span class="token operator">=</span> request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>name<span class="token punctuation">;</span><br>  response<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p>thanks for submitting, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
                <p>
                  This route reads the name from the URL search parameters, then
                  returns the same HTML response as before.
                </p>
              </div>
              <footer class="vstack gap-md pad-xl stripes">
                <h2>Next step</h2>
                <a
                  href="https://github.com/foundersandcoders/server-challenge"
                  target="_blank"
                  rel="noopener"
                  class="button"
                  style="--bg: var(--primary); --bg-hover: var(--primary-dark)"
                  >Complete the challenge<svg
                    viewBox="0 0 20 20"
                    fill="currentColor"
                    width="16"
                    height="16"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5z"
                      clip-rule="evenodd"
                    ></path>
                    <path
                      fill-rule="evenodd"
                      d="M6.194 12.753a.75.75 0 001.06.053L16.5 4.44v2.81a.75.75 0 001.5 0v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 000 1.5h2.553l-9.056 8.194a.75.75 0 00-.053 1.06z"
                      clip-rule="evenodd"
                    ></path></svg
                ></a>
              </footer>
            </div>
          </main>
        </div>
      </div>
    </div>
    <script type="module" src="/assets/js/checkboxen.js"></script>
    <script src="/assets/js/toggle-button.js"></script>
    <script src="/assets/js/copy-text.js"></script>
  </body>
</html>
