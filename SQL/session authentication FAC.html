<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Session authentication</title><link rel="preload" href="/assets/fonts/GT-Eesti-Text-Light-subset.woff2" as="font" type="font/woff2" crossorigin /><link rel="icon" href="/assets/favicon.svg" /><link href="/assets/css/styles.css" rel="stylesheet" /></head><body><div><header class="hstack jc-between pad-lg"><a href="/" aria-label="Home"><img src="/assets/images/logo.svg" width="100" alt /></a><nav id="global-nav"><ul role="list" class="hstack"><li><a class="global-nav__link" href="/course/introduction/">Course</a></li><li><a class="global-nav__link" href="/resources/introduction/">Resources</a></li><li><a class="global-nav__link" href="/about/">About</a></li></ul></nav></header><div class="center"><div class="layout"><aside></aside><main id="main"><div><header class="vstack gap-xl pad-xl stripes"><div class="vstack" data-gap="md"><h1 class="highlight bg-primary">Session authentication</h1><p class="highlight fz-lg">Learn how to log users in using session cookies</p><ul role="list" class="hstack gap-sm wrap"><li class="highlight fz-sm fw-bold" style="--bg: var(--bg-400)">js</li><li class="highlight fz-sm fw-bold" style="--bg: var(--bg-400)">authentication</li><li class="highlight fz-sm fw-bold" style="--bg: var(--bg-400)">postgres</li></ul></div><div class="hstack wrap"><div class="vstack gap-none"><label for="download-command" class="highlight fw-bold" style="--bg: var(--bg-400)">Download files via CLI</label><copy-text class="hstack gap-none ai-stretch"><input id="download-command" readonly value="npx degit 'foundersandcoders/coursebook/src/workshops/session-auth/starter-files#main' session-auth" /><button aria-label="Copy" title="Copy" hidden><svg data-copy width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg><svg hidden data-success width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button></copy-text></div><a href="https://github.com/foundersandcoders/coursebook/issues/new?title=%5Bworkshops%2Fsession-auth%5D&amp;labels=feedback" target="_blank" rel="noopener" class="button">Leave feedback<svg viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293a.783.783 0 01.642-.413 41.102 41.102 0 003.55-.414c1.437-.231 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zM6.75 6a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 2.5a.75.75 0 000 1.5h3.5a.75.75 0 000-1.5h-3.5z" clip-rule="evenodd"></path></svg></a></div></header><div style="margin: 4rem 0" class="flow"><p>This workshop will show you how to combine password-based authentication with cookie-based sessions to keep users logged in to your site.</p>
<h2 id="setup">Setup <a class="heading-anchor" href="#setup">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<ol>
<li>Download the starter files and <code>cd</code> in</li>
<li>Run <code>npm install</code></li>
</ol>
<h3 id="database-setup">Database setup <a class="heading-anchor" href="#database-setup">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h3>
<p>The starter files include two scripts to help with database setup.</p>
<p>Create a new Postgres user and database using:</p>
<pre class="language-shell"><code class="language-shell">./scripts/create_db</code></pre>
<p>This script will also create a <code>.env</code> file containing the <code>DATABASE_URL</code> environment variable, so your server knows how to connect to the local DB.</p>
<p>Insert example data into the database using:</p>
<pre class="language-shell"><code class="language-shell">./scripts/populate_db</code></pre>
<p>This will recreate all the tables from scratch each time you run it, so it can be handy to “reset” everything if you mess up during the workshop.</p>
<p>Finally you can start the server:</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> run dev</code></pre>
<h2 id="code-overview">Code overview <a class="heading-anchor" href="#code-overview">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>Take a moment to look at the existing code. The server has routes for signing up and logging in. The <code>GET</code> routes render forms, but the <code>POST</code> routes don’t do anything but redirect.</p>
<div class="box box-default content flow">
<p><strong>Important:</strong> a <code>COOKIE_SECRET</code> environnment variable is set in the <code>.env</code> file and used to configure the <code>cookie-parser</code> middleware. When you deploy a server to Heroku you’ll need to create a long random string and set it in your app’s “Config vars” in Settings.</p>
</div>
<p>The database created in <code>database/init.sql</code> contains two tables: <code>users</code> and <code>sessions</code>. We’ll be storing new users who sign up in <code>users</code>, and currently logged in users in <code>sessions</code>.</p>
<p>The <code>sessions</code> table has a <code>data</code> column that is the <code>JSON</code> type. This means it can store generic blobs of unstructured data, which is perfect for a session since we don’t know exactly what we want to put in there in advance.</p>
<p>You’re going to implement the sessions-based authentication functionality. You’ll work step-by-step to create each part of the code as a separate function, then bring all the parts together to make the server work.</p>
<div class="box box-default content flow">
<p>There are unit tests for each part of the workshop. You can run these to find out if you’ve implemented the functions correctly. For example:</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">npm</span> run test:one</code></pre>
</div>
<h2 id="part-one-storing-sessions-in-the-db">Part one: storing sessions in the DB <a class="heading-anchor" href="#part-one-storing-sessions-in-the-db">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>The database-related code is separate from the rest of the server logic, in <code>database/model.js</code>. There are already some functions for accessing data in this file.</p>
<p>The model is missing a way to insert new sessions into the database, so you need to write this function.</p>
<ol>
<li>Write a <code>createSession</code> function that takes a session ID and a data object, inserts them into the <code>sessions</code> table, and returns the session ID. For example:<pre class="language-js"><code class="language-js">model<br>  <span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span><span class="token string">"def456"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">just</span><span class="token operator">:</span> <span class="token string">"testing things"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sid</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Logs: "def456"</span></code></pre>
</li>
</ol>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createSession</span><span class="token punctuation">(</span><span class="token parameter">sid<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token constant">INSERT_SESSION</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br>    INSERT INTO sessions (sid, data) VALUES ($1, $2)<br>    RETURNING sid<br>  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> db<br>    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token constant">INSERT_SESSION</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>sid<span class="token punctuation">,</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> result<span class="token punctuation">.</span>rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</details></div>
<h2 id="part-two-signing-up">Part two: signing up <a class="heading-anchor" href="#part-two-signing-up">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>User sign up is a three-step process:</p>
<ol>
<li>Get the submitted user data, hash the password, insert the user into the DB</li>
<li>Create a new session ID, then store the user data in the <code>sessions</code> table (so they’re logged in)</li>
<li>Set a cookie containing the session ID so they stay logged in on future requests</li>
</ol>
<p>The <code>auth.js</code> file is going to contain all the authentication related code. You’ll need to write two functions in here, one to create a user and one to save a session.</p>
<ol>
<li>
<p>Write a <code>createUser</code> function in <code>auth.js</code>. It should take an email, password, and name as arguments, hash the password, then store the user in the database, returning the saved user. For example:</p>
<pre class="language-js"><code class="language-js">auth<br>  <span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span><span class="token string">"oli@o.com"</span><span class="token punctuation">,</span> <span class="token string">"hunter2"</span><span class="token punctuation">,</span> <span class="token string">"Oli"</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Logs: { email: "oli@o.com", name: "Oli" }</span></code></pre>
</li>
<li>
<p>Write a <code>saveUserSession</code> function in <code>auth.js</code>. It should take a user object, generate a random session ID, then store the user data in the <code>sessions</code> table. For example:</p>
<pre class="language-js"><code class="language-js">auth<br>  <span class="token punctuation">.</span><span class="token function">saveUserSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token string">"oli@o.com"</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"Oli"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sid</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Logs: "ljasf7y983wrkbdss="</span></code></pre>
<div class="box box-default content flow">
<p><strong>Hint:</strong> you can generate a random, long session ID using Node’s <code>crypto</code> module:</p>
<pre class="language-js"><code class="language-js">crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
</li>
</ol>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createUser</span><span class="token punctuation">(</span><span class="token parameter">email<span class="token punctuation">,</span> password<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> bcrypt<br>    <span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token operator">=></span> model<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> hash<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">function</span> <span class="token function">saveUserSession</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> sid <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">"base64"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> model<span class="token punctuation">.</span><span class="token function">createSession</span><span class="token punctuation">(</span>sid<span class="token punctuation">,</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> createUser<span class="token punctuation">,</span> saveUserSession<span class="token punctuation">,</span> <span class="token constant">COOKIE_OPTIONS</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
</details></div>
<p>Once those functions are working you need to use them in the <code>/sign-up</code> route:</p>
<ol>
<li>
<p>Use <code>auth.createUser</code> and <code>auth.saveUserSession</code> in <code>routes/signUp.js</code>. Create the user, then save the session, then store the session ID in a cookie before redirecting.</p>
<div class="box box-default content flow">
<p>You can use the <code>auth.COOKIE_OPTIONS</code> export when you set the cookie. You’re going to be setting cookies in multiple places, so it’s a good idea to centralise the config.</p>
</div>
</li>
</ol>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password<span class="token punctuation">,</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  auth<br>    <span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">,</span> name<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>auth<span class="token punctuation">.</span>saveUserSession<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sid</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      response<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">,</span> sid<span class="token punctuation">,</span> auth<span class="token punctuation">.</span><span class="token constant">COOKIE_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      response<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
</details></div>
<h2 id="part-three-logging-in">Part three: logging in <a class="heading-anchor" href="#part-three-logging-in">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>User log in is a very similar three-step process:</p>
<ol>
<li>Get the submitted user data, hash the password, check the hash matches the one you have stored for that user</li>
<li>Create a new session ID, then store the user data in the <code>sessions</code> table (so they’re logged in)</li>
<li>Set a cookie containing the session ID so they stay logged in on future requests</li>
</ol>
<p>Only the first step is different for this route, so you’ll need to write just one more function in <code>auth.js</code>.</p>
<ol>
<li>Write a function <code>verifyUser</code> that takes an email and password as arguments, then gets the stored user from the DB using the email, then uses <code>bcrypt.compare</code> to verify the password. If the passwords match return the user object, otherwise throw an error. For example:<pre class="language-js"><code class="language-js">auth<span class="token punctuation">.</span><span class="token function">verifyUser</span><span class="token punctuation">(</span><span class="token string">"oli@o.com"</span><span class="token punctuation">,</span> <span class="token string">"hunter2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Logs: { email: "oli@o.com", name: "Oli" }</span><br><span class="token comment">// (assuming the password is correct)</span></code></pre>
</li>
</ol>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">verifyUser</span><span class="token punctuation">(</span><span class="token parameter">email<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> model<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Password mismatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> user<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
</details></div>
<p>Once this function is working you need to use it in the <code>/log-in</code> route:</p>
<ol>
<li>Use <code>auth.verifyUser</code>, <code>auth.saveUserSession</code> and <code>auth.COOKIE_OPTIONS</code> in <code>routes/logIn.js</code>. Verify the user’s password, then save the session, then store the session ID in a cookie before redirecting.</li>
</ol>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>body<span class="token punctuation">;</span><br>  auth<br>    <span class="token punctuation">.</span><span class="token function">verifyUser</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>auth<span class="token punctuation">.</span>saveUserSession<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sid</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      response<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">,</span> sid<span class="token punctuation">,</span> auth<span class="token punctuation">.</span><span class="token constant">COOKIE_OPTIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      response<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span></code></pre>
</details></div>
<h2 id="stretch-goal-logging-out">Stretch goal: logging out <a class="heading-anchor" href="#stretch-goal-logging-out">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>The <code>POST /log-out</code> route should delete the stored session from the DB, clear the session cookie and redirect back to the home page.</p>
<ol>
<li>Write a <code>deleteSession</code> function in <code>model.js</code> that takes a session ID and deletes the matching row from the <code>sessions</code> table, returning nothing. For example:<pre class="language-js"><code class="language-js">model<span class="token punctuation">.</span><span class="token function">deleteSession</span><span class="token punctuation">(</span><span class="token string">"def456"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"done"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token comment">// Logs: "done"</span></code></pre>
</li>
<li>Use <code>model.deleteSession</code> in the <code>routes/logOut.js</code>. The handler should delete the session and clear the cookie.</li>
</ol>
</div></div></main></div></div></div><script type="module" src="/assets/js/checkboxen.js"></script><script src="/assets/js/toggle-button.js"></script><script src="/assets/js/copy-text.js"></script></body></html>