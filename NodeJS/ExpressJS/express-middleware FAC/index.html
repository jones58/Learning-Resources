<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Express middleware</title><link rel="preload" href="/assets/fonts/GT-Eesti-Text-Light-subset.woff2" as="font" type="font/woff2" crossorigin /><link rel="icon" href="/assets/favicon.svg" /><link href="/assets/css/styles.css" rel="stylesheet" /></head><body><div><header class="hstack jc-between pad-lg"><a href="/" aria-label="Home"><img src="/assets/images/logo.svg" width="100" alt /></a><nav id="global-nav"><ul role="list" class="hstack"><li><a class="global-nav__link" href="/course/introduction/">Course</a></li><li><a class="global-nav__link" href="/resources/introduction/">Resources</a></li><li><a class="global-nav__link" href="/about/">About</a></li></ul></nav></header><div class="center"><div class="layout"><aside></aside><main id="main"><div><header class="vstack gap-xl pad-xl stripes"><div class="vstack" data-gap="md"><h1 class="highlight bg-primary">Express middleware</h1><p class="highlight fz-lg">Learn how to create your own middleware for Express servers</p><ul role="list" class="hstack gap-sm wrap"><li class="highlight fz-sm fw-bold" style="--bg: var(--bg-400)">js</li><li class="highlight fz-sm fw-bold" style="--bg: var(--bg-400)">express</li><li class="highlight fz-sm fw-bold" style="--bg: var(--bg-400)">middleware</li></ul></div><div class="hstack wrap"><div class="vstack gap-none"><label for="download-command" class="highlight fw-bold" style="--bg: var(--bg-400)">Download files via CLI</label><copy-text class="hstack gap-none ai-stretch"><input id="download-command" readonly value="npx degit 'foundersandcoders/coursebook/src/workshops/express-middleware/starter-files#main' express-middleware" /><button aria-label="Copy" title="Copy" hidden><svg data-copy width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg><svg hidden data-success width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button></copy-text></div><a href="https://github.com/foundersandcoders/coursebook/issues/new?title=%5Bworkshops%2Fexpress-middleware%5D&amp;labels=feedback" target="_blank" rel="noopener" class="button">Leave feedback<svg viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M10 2c-2.236 0-4.43.18-6.57.524C1.993 2.755 1 4.014 1 5.426v5.148c0 1.413.993 2.67 2.43 2.902 1.168.188 2.352.327 3.55.414.28.02.521.18.642.413l1.713 3.293a.75.75 0 001.33 0l1.713-3.293a.783.783 0 01.642-.413 41.102 41.102 0 003.55-.414c1.437-.231 2.43-1.49 2.43-2.902V5.426c0-1.413-.993-2.67-2.43-2.902A41.289 41.289 0 0010 2zM6.75 6a.75.75 0 000 1.5h6.5a.75.75 0 000-1.5h-6.5zm0 2.5a.75.75 0 000 1.5h3.5a.75.75 0 000-1.5h-3.5z" clip-rule="evenodd"></path></svg></a></div></header><div style="margin: 4rem 0" class="flow"><p>Learn how to write your own Express middleware to do logging and authentication.</p>
<h2 id="middleware">Middleware <a class="heading-anchor" href="#middleware">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>Express is built around middleware. Middleware are functions that receive a request, do something with it, then either pass the request on to the next middleware or send a response (ending the chain).</p>
<p>Technically <em>all</em> route handlers are middleware, since they fit the above definition. However middleware usually <em>transform</em> the request in some way and don’t actually send a response.</p>
<p>For example the built in <code>express.urlencoded</code> middleware grabs the HTTP request body, turns it into an object, then attaches it to the request object. This allows subsequent handlers to easily access it at <code>request.body</code>. The 3rd party <code>cookie-parser</code> middleware does the same for cookies. We’re going to learn how to create our own middleware functions.</p>
<h2 id="setup">Setup <a class="heading-anchor" href="#setup">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<ol>
<li>Download the starter files and <code>cd</code> in</li>
<li>Run <code>npm install</code> to install all the dependencies</li>
<li>Run <code>npm run dev</code> to start the development server</li>
</ol>
<p>Visit <a href="http://localhost:3000">http://localhost:3000</a> to see the workshop app. You can “log in” by entering an email, which will be saved as a cookie so the server can identify you.</p>
<h2 id="our-first-middleware">Our first middleware <a class="heading-anchor" href="#our-first-middleware">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<p>It would be useful if our server logged each incoming request to our terminal. That way we can see a log of what’s happening as we use our server locally.</p>
<p>Usually we match our handlers to specific routes (e.g. <code>server.get(&quot;/about&quot;, ...)</code>. However we can run a handler for <em>every</em> route by using <code>server.use</code>:</p>
<pre class="language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This will log the method and URL for every request the server receives (e.g. <code>GET /</code> or <code>POST /submit</code>). Unfortunately that’s <em>all</em> it will do, as this handler never tells the next handler in the chain to run. This will cause all requests to time out, since the server never sends a response using <code>response.send</code>.</p>
<p>We can fix this with the third argument all handlers receive: <code>next</code>. This is a function you call inside a handler when you want Express to move on to the next one.</p>
<pre class="language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This tells Express to run the logger handler before every request, then move on to whatever handler is queued for that route. E.g. if the user requests the home page (<code>GET /</code>) this handler will run, log the method/URL, then pass on to the next handler that matches <code>GET /</code>, which will send an HTML response.</p>
<hr>
<h2 id="authentication-middleware">Authentication middleware <a class="heading-anchor" href="#authentication-middleware">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h2>
<div class="box box-default content flow">
<p><strong>Note:</strong> we are just storing all the session info about the user in an object in-memory. In a real app you’d want this to live in a persistent store like a database.</p>
</div>
<h3 id="accessing-the-user">Accessing the user <a class="heading-anchor" href="#accessing-the-user">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h3>
<p>Currently we are accessing the user cookie in three handlers (<code>GET /</code>, <code>GET /profile</code> and <code>GET /profile/settings</code>). We have to grab the session ID from the signed cookies, then look the session info up in the <code>sessions</code> object. This ends up being quite a lot of code repeated whenever we want to find out info about which user is currently logged in. We can create a middleware to handle this repeated task.</p>
<p>We don’t know which routes will want to access the logged in user value so we’ll set this middleware on the whole app using <code>server.use</code>. We’ll mimic the other middleware we’re using and add the <code>user</code> value to the <code>req</code> object. This lets us pass values down through the request chain to later handlers.</p>
<h4 id="challenge-1-1">Challenge 1.1 <a class="heading-anchor" href="#challenge-1-1">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h4>
<ol>
<li>Create a new middleware that runs before every request.</li>
<li>It should read the <code>sid</code> cookie and find the session info in the <code>sessions</code> object</li>
<li>Then create a “session” property on the request object containing that info</li>
<li>Finally call the <code>next</code> function to tell Express to move on to the next handler.</li>
<li>Change each handler that currently gets the session cookie to instead grab the info from <code>req.session</code>.</li>
</ol>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> sid <span class="token operator">=</span> req<span class="token punctuation">.</span>signedCookies<span class="token punctuation">.</span>sid<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> sessionInfo <span class="token operator">=</span> sessions<span class="token punctuation">[</span>sid<span class="token punctuation">]</span><span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>sessionInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    req<span class="token punctuation">.</span>session <span class="token operator">=</span> sessionInfo<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> user <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">;</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/profile"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> user <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">;</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/profile/settings"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> user <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">;</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</details></div>
<h3 id="protecting-routes">Protecting routes <a class="heading-anchor" href="#protecting-routes">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h3>
<p>Currently our <code>GET /profile</code> route is broken. If the user isn’t logged in we get an error trying to access <code>user.email</code> (since <code>req.session</code> is undefined). It would be better to show a “Please log in” page for unauthenticated users.</p>
<h4 id="challenge-1-2">Challenge 1.2 <a class="heading-anchor" href="#challenge-1-2">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h4>
<ol>
<li>Amend the <code>GET /profile</code> handler to check whether there is a session.</li>
<li>If not send a <code>401</code> HTML response with an error message in the <code>h1</code> and a link to the <code>/log-in</code> page.</li>
</ol>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/profile"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> user <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br>      &lt;h1>Please log in to view this page&lt;/h1><br>      &lt;a href="/log-in">Log in&lt;/a><br>    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1>Hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h1></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</details></div>
<p>Now you should see the “please log in” page if you visit <code>/profile</code> when you aren’t logged in. However the <code>GET /profile/settings</code> route has the same problem.</p>
<p>We <em>could</em> copy paste the above code, but it would be better to avoid the duplication and move this logic into a middleware that makes sure users are logged in.</p>
<h4 id="challenge-1-3">Challenge 1.3 <a class="heading-anchor" href="#challenge-1-3">
  <svg
    viewBox="0 0 32 32"
    width="20"
    height="20"
    fill="none"
    stroke="currentcolor"
    stroke-linecap="round"
    stroke-linejoin="round"
    stroke-width="2"
  >
    <path
      d="M18 8 C18 8 24 2 27 5 30 8 29 12 24 16 19 20 16 21 14 17 M14 24 C14 24 8 30 5 27 2 24 3 20 8 16 13 12 16 11 18 15"
    ></path>
  </svg>
</a></h4>
<ol>
<li>Create a new middleware function named <code>checkAuth</code> that takes <code>req</code>, <code>res</code> and <code>next</code> as arguments.</li>
<li>If there is no <code>req.session</code> respond with the <code>401</code> HTML.</li>
<li>If there is a <code>req.session</code> call <code>next</code> to move on to the next handler.</li>
<li>Add this middleware in front of the handler for any route we want to protect. We don’t want this middleware running on all routes, since some of them are public.</li>
</ol>
<div class="box box-default content flow">
<p><strong>Hint:</strong> you can set multiple middleware/handlers for a route by passing multiple arguments.</p>
<pre class="language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/example"</span><span class="token punctuation">,</span> doSomething<span class="token punctuation">,</span> anotherHandler<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</div>
<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">checkAuth</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> user <span class="token operator">=</span> req<span class="token punctuation">.</span>session<span class="token punctuation">;</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><br>      &lt;h1>Please log in to view this page&lt;/h1><br>      &lt;a href="/log-in">Log in&lt;/a><br>    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/profile"</span><span class="token punctuation">,</span> checkAuth<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"/profile/settings"</span><span class="token punctuation">,</span> checkAuth<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token comment">// ...</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
</details></div>
<!--

## Error-handling

The `next` function is also used for error-handling. If you call it with no arguments Express will move to the next handler in the chain as we just saw.

However if you call it with an argument Express will skip all the rest of the handlers for this route and instead run the error handler.

For example if we encounter an error reading from a database:

```js
server.get("/example", (req, res, next) => {
  model
    .getSomething()
    .then((result) => {
      // do success stuff
    })
    .catch((error) => {
      // stop all route handlers and jump to error handler
      next(error);
    });
});
```

Calling `next(error)` stops this handler executing and jumps straight to the first error-handling middleware. If you haven't created any of your own then Express' built-in one will handle the error. By default this will respond with a `500` status code. Express will also catch any synchronous errors that get thrown by your server automatically.

### Error handling middleware

Creating our own error-handling middleware is a little weird. An error-handler has _four_ arguments instead of the usual two or three—the first is the error itself:

```js
function handleErrors(error, req, res, next) {
  // handle the error
}

server.use(handleErrors);
```

Express knows this middleware is for errors (because it has four arguments), so it will only get called when there's an error to deal with (i.e when a handler calls `next` with an argument, or an error is thrown).

#### Challenge 2.1

1. Add an error-handling middleware to your server.
1. It should log the error it receives, then respond with a `500` status and a generic HTML message.

You can test this by visiting the http://localhost:3000/error route to cause a fake error.

<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>

```js
function handleErrors(error, req, res, next) {
  console.error(error);
  res.status(500).send(`<h1>Something went wrong</h1>`);
}

server.use(handleErrors);
```

</details></div>

### Custom error responses

The `500` status code is for general server errors, but sometimes we might want to be more specific. Since JavaScript errors are objects we can attach extra properties to them to provide more information for the error handler to use.

#### Challenge 2.2

1. Amend the `GET /error` handler to add a `status` property to the `fakeError` object with a value of `403`.
1. Amend your error handler to use this property as the response status code (defaulting to `500` if there isn't one).

<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>

```js
server.get("/error", (req, res, next) => {
  const fakeError = new Error("uh oh");
  fakeError.status = 403;
  next(fakeError);
});

function handleErrors(error, req, res, next) {
  console.error(error);
  const status = error.status || 500;
  res.status(status).send(`<h1>Something went wrong</h1>`);
}

server.use(handleErrors);
```

</details></div>

Open the network tab and visit the `/error` route again. You should see a `403` response instead of `500`.

## Stretch goal: refactoring

It's a bit cluttered having all our middleware mixed in with our handlers. Create a `middleware/` directory with files for each middleware function we built. Export each one, then import them in `server.js` to use.

You'll also need to move the `sessions` object out into its own file and export it so it's available to anything that needs it.

## Stretch goal: fancier error-handling

The built-in Express error-handler does a bit more than just sending a static error message. It behaves differently in development and production.

While you're developing locally it sends the entire error's stack trace as a response, allowing you to see exactly what went wrong in the browser. For example:

```
Error: uh oh
    at /Users/yourname/Code/fac/workshops/learn-express-middleware/workshop/server.js:73:21
    at Layer.handle [as handle_request] (/Users/yourname/Code/fac/workshops/learn-express-middleware/node_modules/express/lib/router/layer.js:95:5)
    at next (/Users/yourname/Code/fac/workshops/learn-express-middleware/node_modules/express/lib/router/route.js:137:13)
    at Route.dispatch (/Users/yourname/Code/fac/workshops/learn-express-middleware/node_modules/express/lib/router/route.js:112:3)
    ...
```

This would be dangerous for real users to have access to, so in production it reads the `status` property from the error object (just like we did above), and just sends the default message for each status code (e.g. `404 -> Not found`). The `status` property defaults to `500 -> Internal server error` if you don't set it.

Let's make our custom error handler behave the same way.

Node actually comes with a list of all the HTTP error codes and their messages. You can get them from `http.STATUS_CODES`. For example:

```js
const { STATUS_CODES } = require("http");

console.log(STATUS_CODES[401]); // "Unauthorized"
```

You can check whether your app is running in production using `process.env.NODE_ENV`. Production environments like Heroku will set this environment variable to "production".

Amend your error-handler to send a standard HTTP status message in production, and the entire error stack trace in development. To test you can amend the `"dev"` script in the `package.json` to `NODE_ENV=production nodemon workshop/server.js`.

<div class="box box-default content flow">

**Hint:** look at the `error.stack` property. You ca also use a `<pre>` tag to make the stack display nicely.

</div>

<div class="box box-success content"><details class="disclosure flow"><summary>Toggle answer</summary>

```js
function handleErrors(error, req, res, next) {
  console.error(error);
  const status = error.status || 500;
  res.status(status);

  const inProd = process.env.NODE_ENV === "production";
  if (inProd) {
    const message = STATUS_CODES[status];
    res.send(message);
  } else {
    res.send(`<pre>${error.stack}</pre>`);
  }
}

server.use(handleErrors);
```

</details></div> -->
</div></div></main></div></div></div><script type="module" src="/assets/js/checkboxen.js"></script><script src="/assets/js/toggle-button.js"></script><script src="/assets/js/copy-text.js"></script></body></html>